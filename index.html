<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UPDATE - Cloud Sync Final</title>
    <style>
        :root { --primary: #4cb6f2; --danger: #ef4444; --bg: #f0f4f8; --text: #334155; --success: #22c55e; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); padding-bottom: 90px; color: var(--text); }
        header { background: white; padding: 12px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .controls { display: flex; gap: 8px; margin-bottom: 10px; }
        .filter-select { flex: 2; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 1.1rem; }
        .btn-add { flex: 1; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1.1rem; }
        .search-bar { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; font-size: 1.1rem; box-sizing: border-box; }
        .container { padding: 10px; }
        .card { background: white; border-radius: 12px; padding: 14px; margin-bottom: 10px; border: 1px solid #e2e8f0; }
        .item-name { width: 100%; border: none; border-bottom: 1px solid #eee; font-size: 1.2rem; font-weight: bold; padding: 5px 0; outline: none; margin-bottom: 10px; }
        .row-2 { display: flex; align-items: center; justify-content: space-between; gap: 5px; }
        .item-date { width: 145px; border: 1px solid #ddd; border-radius: 6px; padding: 8px; font-size: 1rem; text-align: center; font-family: monospace; }
        .item-days { font-size: 0.9rem; background: #eee; padding: 6px 8px; border-radius: 6px; font-weight: bold; min-width: 45px; text-align: center; }
        .btn-sm { border: none; border-radius: 6px; padding: 10px 12px; color: white; font-weight: bold; font-size: 0.9rem; }
        button:active { transform: scale(0.95); opacity: 0.8; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; height: 80px; z-index: 200; display: flex; align-items: center; padding: 0 10px; box-sizing: border-box; }
        .nav-left { flex: 1.2; display: flex; height: 100%; }
        .tab-item { flex: 1; border: none; background: none; font-size: 1.4rem; font-weight: bold; color: #94a3b8; }
        .tab-item.active { color: var(--primary); border-top: 4px solid var(--primary); background: #f0f9ff; }
        .nav-right { flex: 1; display: flex; gap: 5px; justify-content: flex-end; }
        .btn-csv-nav { background: #f8fafc; border: 1px solid #ddd; border-radius: 8px; padding: 10px 8px; font-size: 0.9rem; font-weight: bold; color: #475569; }
        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.9rem; z-index: 1000; display: none; pointer-events: none; }
        .hist-info { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #e2e8f0; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="toast"></div>

<header id="header-ui">
    <div class="controls">
        <select id="filter-cat" class="filter-select" onchange="renderList()"></select>
        <button class="btn-add" onclick="addItem()">ï¼‹ è¿½åŠ </button>
    </div>
    <input type="text" id="search-input" class="search-bar" placeholder="åå‰æ¤œç´¢" oninput="renderList()">
</header>

<div class="container">
    <div id="screen-list"></div>
    <div id="screen-history" class="hidden">
        <button onclick="showScreen('list')" style="padding:10px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd; background:white;">â† æˆ»ã‚‹</button>
        <div class="hist-info">
            <input type="text" id="hist-edit-name" class="item-name" onchange="saveHistEdit()">
            <div style="display:flex; align-items:center; gap:10px;">
                <span>ã‚«ãƒ†ã‚´ãƒª:</span>
                <select id="hist-edit-cat" class="filter-select" onchange="saveHistEdit()"></select>
            </div>
        </div>
        <h3 style="border-left: 5px solid var(--primary); padding-left: 10px;">æ›´æ–°å±¥æ­´</h3>
        <div id="history-content"></div>
    </div>
    <div id="screen-master" class="hidden">
        <h2 style="border-left: 5px solid var(--primary); padding-left: 10px;">ã‚«ãƒ†ã‚´ãƒªç®¡ç†</h2>
        <div id="master-list"></div>
        <button onclick="addMaster()" class="btn-add" style="width:100%; margin-top:20px; padding:18px;">ï¼‹ ã‚«ãƒ†ã‚´ãƒªè¿½åŠ </button>
    </div>
</div>

<nav class="nav-bar">
    <div class="nav-left">
        <button id="tab-list" class="tab-item active" onclick="showScreen('list')">ãƒªã‚¹ãƒˆ</button>
        <button id="tab-master" class="tab-item" onclick="showScreen('master')">ã‚«ãƒ†ã‚´ãƒª</button>
    </div>
    <div class="nav-right">
        <button class="btn-csv-nav" onclick="syncWithSheets()">ğŸ”„ åŒæœŸ</button>
        <button class="btn-csv-nav" onclick="handleImportClick()">ğŸ“¥ èª­è¾¼</button>
        <button class="btn-csv-nav" onclick="handleExportClick()">ğŸ“¤ å‡ºåŠ›</button>
    </div>
</nav>

<input type="file" id="csv-input" class="hidden" accept=".csv" onchange="processFile(this)">

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbyAH60T5LlpXB_EDNDVyrcdndvji82QJ5rPFICarB4R4mkmDCNtqZ21xqJ85EOpVKD3PA/exec"; // â† 1ç®‡æ‰€ã ã‘æ›¸ãæ›ãˆ

let db, dataList = [], categories = [], currentView = 'list', currentEditIdx = -1;

const request = indexedDB.open("UpdateFinalDB_v110", 1);
request.onupgradeneeded = (e) => {
    db = e.target.result;
    db.createObjectStore("store", { keyPath: "id" });
};
request.onsuccess = (e) => { db = e.target.result; loadFromDB(); };

// æ—¥æœ¬æ™‚é–“ (JST) å–å¾—
function getTodayJST() {
    const now = new Date();
    const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    return jstNow.toISOString().split('T')[0];
}

function showToast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg; t.style.display = 'block';
    setTimeout(() => { t.style.display = 'none'; }, 2000);
}

function loadFromDB() {
    const tx = db.transaction(["store"], "readonly");
    const s = tx.objectStore("store");
    s.get("dataList").onsuccess = (e) => { dataList = e.target.result?.value || []; renderList(); };
    s.get("categories").onsuccess = (e) => { categories = e.target.result?.value || ["é£Ÿå“", "æ—¥ç”¨å“"]; updateFilterUI(); };
}

function autoSave() {
    const tx = db.transaction(["store"], "readwrite");
    const s = tx.objectStore("store");
    s.put({ id: "dataList", value: dataList });
    s.put({ id: "categories", value: categories });
    updateFilterUI();
}

function updateFilterUI() {
    const filters = [document.getElementById('filter-cat'), document.getElementById('hist-edit-cat')];
    filters.forEach(f => {
        if(!f) return;
        const cur = f.value;
        f.innerHTML = f.id === 'filter-cat' ? '<option value="all">ã™ã¹ã¦è¡¨ç¤º</option>' : '<option value="">æœªè¨­å®š</option>';
        categories.forEach(c => { if(c && c.trim()) f.innerHTML += `<option value="${c}">${c}</option>`; });
        f.value = categories.includes(cur) ? cur : (f.id === 'filter-cat' ? 'all' : '');
    });
}

function showScreen(id) {
    currentView = id;
    ['list', 'history', 'master'].forEach(s => document.getElementById('screen-'+s).classList.add('hidden'));
    document.getElementById('header-ui').classList.toggle('hidden', id !== 'list');
    document.getElementById('screen-' + id).classList.remove('hidden');
    document.getElementById('tab-list').classList.toggle('active', id === 'list');
    document.getElementById('tab-master').classList.toggle('active', id === 'master');
    if(id === 'master') renderMaster();
    if(id === 'list') renderList();
}

function addItem() {
    const f = document.getElementById('filter-cat').value;
    const cat = (f === 'all') ? "" : f;
    dataList.unshift({ id: Date.now(), category: cat, name: "", history: [], tempDate: getTodayJST() });
    renderList(); autoSave(); showToast("ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ã—ã¾ã—ãŸ");
}

function doUpdate(idx) {
    const targetDate = dataList[idx].tempDate || getTodayJST();
    dataList[idx].history.unshift(targetDate);
    dataList[idx].history.sort((a, b) => new Date(b) - new Date(a));
    dataList[idx].tempDate = getTodayJST();
    renderList(); autoSave(); showToast("å±¥æ­´ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
}

function viewHistory(idx) {
    currentEditIdx = idx;
    const item = dataList[idx];
    document.getElementById('hist-edit-name').value = item.name;
    document.getElementById('hist-edit-cat').value = item.category;
    const cont = document.getElementById('history-content');
    cont.innerHTML = item.history.map((h, i) => `
        <div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #eee; background:white;">
            <span>${h}</span>
            <button onclick="deleteHist(${idx}, ${i})" style="color:red; border:none; background:none;">å‰Šé™¤</button>
        </div>
    `).join('') || "å±¥æ­´ãªã—";
    showScreen('history');
}

function saveHistEdit() {
    if(currentEditIdx === -1) return;
    dataList[currentEditIdx].name = document.getElementById('hist-edit-name').value;
    dataList[currentEditIdx].category = document.getElementById('hist-edit-cat').value;
    autoSave(); showToast("ä¿å­˜ã—ã¾ã—ãŸ");
}

function deleteHist(itemIdx, histIdx) {
    dataList[itemIdx].history.splice(histIdx, 1);
    viewHistory(itemIdx); autoSave(); showToast("å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
}

function renderMaster() {
    const container = document.getElementById('master-list');
    container.innerHTML = categories.map((c, i) => `
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <input type="text" value="${c}" style="flex:1; padding:12px; border-radius:8px; border:1px solid #ddd;" onchange="categories[${i}]=this.value; autoSave(); showToast('ä¿å­˜ã—ã¾ã—ãŸ');">
            <button onclick="if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){categories.splice(${i},1); autoSave(); renderMaster(); showToast('å‰Šé™¤ã—ã¾ã—ãŸ');}" style="background:var(--danger); color:white; border:none; border-radius:8px; padding:0 15px;">Ã—</button>
        </div>
    `).join('');
}

function addMaster() { categories.push("æ–°ã‚«ãƒ†ã‚´ãƒª"); renderMaster(); autoSave(); showToast("ã‚«ãƒ†ã‚´ãƒªè¿½åŠ "); }

function renderList() {
    const container = document.getElementById('screen-list');
    container.innerHTML = '';
    const filter = document.getElementById('filter-cat').value;
    const key = document.getElementById('search-input').value.toLowerCase();
    
    dataList.forEach((item, originalIdx) => {
        if(filter !== 'all' && item.category !== filter) return;
        if(key && !(item.name || "").toLowerCase().includes(key)) return;

        const latestHistoryDate = (item.history && item.history.length > 0) ? item.history[0] : "";
        const calendarValue = latestHistoryDate || item.tempDate || getTodayJST();

        let diff = "- ";
        if(latestHistoryDate) {
            const d1 = new Date(); d1.setHours(0,0,0,0);
            const d2 = new Date(latestHistoryDate); d2.setHours(0,0,0,0);
            if(!isNaN(d2.getTime())) diff = Math.floor((d1 - d2) / (1000*60*60*24));
        }

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <input type="text" class="item-name" placeholder="åå‰å…¥åŠ›..." value="${item.name || ''}" onchange="dataList[${originalIdx}].name=this.value; autoSave(); showToast('ä¿å­˜ã—ã¾ã—ãŸ');">
            <div class="row-2">
                <input type="date" class="item-date" value="${calendarValue}" onchange="dataList[${originalIdx}].tempDate=this.value; autoSave(); renderList();">
                <span class="item-days">${diff}æ—¥</span>
                <div class="btn-group">
                    <button class="btn-sm" style="background:#94a3b8" onclick="viewHistory(${originalIdx})">å±¥æ­´</button>
                    <button class="btn-sm" style="background:#4cb6f2" onclick="doUpdate(${originalIdx})">æ›´æ–°</button>
                    <button class="btn-sm" style="background:#f87171" onclick="if(confirm('å‰Šé™¤')){dataList.splice(${originalIdx},1); renderList(); autoSave(); showToast('å‰Šé™¤');}">Ã—</button>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
}

// --- åŒæœŸæ©Ÿèƒ½ (ä¿å­˜ã—ã¦ã‹ã‚‰èª­ã¿è¾¼ã‚€åŒæ–¹å‘åŒæœŸ) ---
async function syncWithSheets() {
    if(!GAS_URL || GAS_URL.includes("ã“ã“ã«")) return alert("GASã®URLã‚’è¨­å®šã—ã¦ãã ã•ã„");
    showToast("ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ä¿å­˜ä¸­...");
    try {
        // 1. ã¾ãšç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã¸é€ã‚‹ (POST)
        await fetch(GAS_URL, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify({ dataList: dataList, categories: categories })
        });

        // é€šä¿¡ã®å®‰å®šå¾…ã¡
        await new Promise(r => setTimeout(r, 500));
        showToast("æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...");

        // 2. ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ (GET)
        const res = await fetch(GAS_URL, { redirect: "follow" });
        const json = await res.json();
        
        if (json.dataList) {
            // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¡Œåˆ—ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
            dataList = json.dataList.filter(row => row[1]).map((row, i) => ({
                id: Date.now() + i,
                category: row[0] || "",
                name: row[1] || "",
                tempDate: getTodayJST(),
                history: row[2] ? row[2].toString().split('|').filter(d => d) : []
            }));
            if (json.categories) {
                categories = json.categories.map(row => row[0]).filter(c => c);
            }
            
            autoSave();
            renderList();
            showToast("åŒæœŸå®Œäº†ï¼");
        }
    } catch (e) {
        showToast("åŒæœŸå¤±æ•—");
        console.error(e);
    }
}

function handleImportClick() { document.getElementById('csv-input').click(); }
function processFile(input) {
    if(!input.files.length) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const lines = e.target.result.split(/\r?\n/);
        let count = 0;
        const newList = [];
        lines.forEach((l, i) => {
            if(!l.trim()) return;
            const p = l.split(',');
            newList.push({
                id: Date.now() + i, category: p[0] || "", name: p[1] || "",
                tempDate: getTodayJST(), history: p[2] ? p[2].split('|').filter(d => d) : []
            });
            count++;
        });
        dataList = [...newList, ...dataList];
        autoSave(); renderList();
        showToast(`${count}ä»¶å–ã‚Šè¾¼ã¿ã¾ã—ãŸ`);
    };
    reader.readAsText(input.files[0], "UTF-8");
}

function handleExportClick() {
    let csv = "";
    dataList.forEach(item => { csv += `${item.category},${item.name},${item.history.join('|')}\n`; });
    const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
    const blob = new Blob([bom, csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.download = `backup_${Date.now()}.csv`; a.href = url; a.click();
    showToast("CSVã‚’å‡ºåŠ›ã—ã¾ã—ãŸ");
}
</script>
</body>
</html>
